name: Selenium CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    # ---------------- START NOTIFICATION ----------------
    - name: Notify Start - Google Chat
      run: |
        curl -H 'Content-Type: application/json' \
        -d "{\"text\": \"ğŸš€ *Test Execution Started*\nğŸ”¹ *Repo:* ${{ github.repository }}\nğŸ‘¤ *Triggered by:* ${{ github.actor }}\nğŸ” *Run ID:* #${{ github.run_number }}\"}" \
        "${{ secrets.GOOGLE_CHAT_WEBHOOK }}"

    # ---------------- CHECKOUT ----------------
    - name: Checkout repo
      uses: actions/checkout@v3

    # ---------------- JAVA SETUP ----------------
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    # ---------------- RUN TESTS ----------------
    - name: Build with Maven and run tests
      continue-on-error: true
      run: mvn clean test -DsuiteXmlFile=testng.xml

    # ---------------- PARSE TESTNG RESULTS ----------------
    - name: Parse TestNG Results
      id: testng
      run: |
        FILE="target/surefire-reports/testng-results.xml"

        TOTAL=$(grep -oP 'total="\K\d+' "$FILE" || echo 0)
        PASSED=$(grep -oP 'passed="\K\d+' "$FILE" || echo 0)
        FAILED=$(grep -oP 'failed="\K\d+' "$FILE" || echo 0)
        SKIPPED=$(grep -oP 'skipped="\K\d+' "$FILE" || echo 0)

        echo "total=$TOTAL" >> $GITHUB_OUTPUT
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
        echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

    # ---------------- ARCHIVE REPORT ----------------
    - name: Archive Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: surefire-report
        path: target/surefire-reports/

    # ---------------- CREATE TIMESTAMP FOLDER ----------------
    - name: Create timestamped report directory
      if: always()
      id: timestamp
      run: |
        export TS="run-$(date +%Y-%m-%d_%H-%M-%S)"
        mkdir -p gh-pages/$TS
        cp -r target/surefire-reports/* gh-pages/$TS/
        echo "report_path=$TS" >> $GITHUB_OUTPUT

    # ---------------- DEPLOY REPORT TO GITHUB PAGES ----------------
    - name: Deploy timestamped report to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        personal_token: ${{ secrets.REPORT_REPO_PAT }}
        publish_dir: gh-pages

    # ---------------- SEND GOOGLE CHAT COMPLETION ----------------
    - name: Notify Completion - Google Chat
      if: always()
      run: |
        STATUS="${{ job.status }}"
        REPORT_PATH="${{ steps.timestamp.outputs.report_path }}"
        REPORT_URL="https://Shahid954.github.io/api-test-reports/${REPORT_PATH}/emailable-report.html"

        curl -H 'Content-Type: application/json' \
        -d "{\"text\": \"âœ… *Test Execution Completed*\nğŸ“„ *Status:* $STATUS\n\nğŸ“Š *Test Summary*\nâ€¢ Total Tests: ${{ steps.testng.outputs.total }}\nâ€¢ Passed: ${{ steps.testng.outputs.passed }}\nâ€¢ Failed: ${{ steps.testng.outputs.failed }}\nâ€¢ Skipped: ${{ steps.testng.outputs.skipped }}\n\nğŸ“ *Report:* $REPORT_URL\nğŸ‘¤ Triggered by: ${{ github.actor }}\nğŸ” Run ID: #${{ github.run_number }}\"}" \
        "${{ secrets.GOOGLE_CHAT_WEBHOOK }}"

    # ---------------- SEND EMAIL ----------------
    - name: Send Email Report
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Test Execution Report - Run #${{ github.run_number }}"
        to: "mohd.shahid@thinkitive.com"
        from: "mohd.shahid@thinkitive.com"
        attachments: "target/surefire-reports/emailable-report.html"
        body: |
          Hello Team,

          The Selenium automation execution has been completed.

          ğŸ“Š Test Summary:
          â€¢ Total: ${{ steps.testng.outputs.total }}
          â€¢ Passed: ${{ steps.testng.outputs.passed }}
          â€¢ Failed: ${{ steps.testng.outputs.failed }}
          â€¢ Skipped: ${{ steps.testng.outputs.skipped }}

          ğŸ”— Detailed Report:
          https://github.com/Shahid954/CI_Integration/api-test-reports/${{ steps.timestamp.outputs.report_path }}/emailable-report.html

          Regards,
          Shahid
