name: Selenium CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    - name: Notify Start - Google Chat
      run: |
        curl -H 'Content-Type: application/json' \
        -d "{\"text\": \"ðŸš€ *Test Execution Started*\nðŸ”¹ Repo: ${{ github.repository }}\nðŸ‘¤ Triggered by: ${{ github.actor }}\nðŸ” Run ID: #${{ github.run_number }}\"}" \
        "${{ secrets.GOOGLE_CHAT_WEBHOOK }}"

    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Build with Maven and run tests
      continue-on-error: true
      run: mvn clean test -DsuiteXmlFile=testng.xml

    - name: Archive Test Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: surefire-report
        path: target/surefire-reports/

    # --------------------------------------------------
    #  Install xmllint for extracting TestNG summary
    # --------------------------------------------------
    - name: Install xmllint
      if: always()
      run: |
        sudo apt-get update
        sudo apt-get install -y libxml2-utils

    # --------------------------------------------------
    #  Extract TestNG Summary (total, passed, failed, skipped)
    # --------------------------------------------------
    - name: Extract TestNG Results
      id: testng
      if: always()
      run: |
        FILE="target/surefire-reports/testng-results.xml"
        total=$(xmllint --xpath "string(/testng-results/@total)" "$FILE")
        passed=$(xmllint --xpath "string(/testng-results/@passed)" "$FILE")
        failed=$(xmllint --xpath "string(/testng-results/@failed)" "$FILE")
        skipped=$(xmllint --xpath "string(/testng-results/@skipped)" "$FILE")

        echo "total=$total" >> $GITHUB_OUTPUT
        echo "passed=$passed" >> $GITHUB_OUTPUT
        echo "failed=$failed" >> $GITHUB_OUTPUT
        echo "skipped=$skipped" >> $GITHUB_OUTPUT

    - name: Create timestamped report directory
      if: always()
      id: timestamp
      run: |
        export TS="run-$(date +%Y-%m-%d_%H-%M-%S)"
        mkdir -p gh-pages/$TS
        cp -r target/surefire-reports/* gh-pages/$TS/
        echo "report_path=$TS" >> $GITHUB_OUTPUT

    - name: Deploy timestamped report to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        personal_token: ${{ secrets.REPORT_REPO_PAT }}
        external_repository: Shahid954/api-test-reports
        publish_branch: gh-pages
        publish_dir: gh-pages
        keep_files: true

    # ------------------
